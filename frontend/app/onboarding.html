<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Onboarding</title>
  <link rel="stylesheet" href="assets/css/app.css">
  <style>
    .container {
      max-width: 700px;
      margin: 40px auto;
      background: #fff;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
    }

    .question-field {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 20px;
    }

    .question-field label {
      font-weight: 600;
      font-size: 1rem;
      color: #2d3748;
    }

    .question-field input,
    .question-field select,
    .question-field textarea {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #cbd5e0;
      border-radius: 8px;
      font-size: 1rem;
      background: #fff;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    .question-field input:focus,
    .question-field select:focus,
    .question-field textarea:focus {
      outline: none;
      border-color: #3182ce;
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5);
    }

    .submit-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #4299e1, #3182ce, #2c5282);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
    }

    .submit-btn:hover {
      background: linear-gradient(135deg, #3182ce, #2c5282, #2a4365);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(66, 153, 225, 0.4);
    }

    .submit-btn:active {
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <div id="loadingOverlay" class="loading-overlay" style="display:none;">
    <div class="loading-spinner"></div>
  </div>

  <div class="container">
    <form id="onboardingForm" class="onboarding-form" style="display:none;"></form>
  </div>

  <script src="assets/js/config.js"></script>
  <script type="module" src="assets/js/utils/utils.js"></script>
  <script type="module" src="assets/js/auth.js"></script>
  <script type="module" src="assets/js/onboarding-manager.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const form = document.getElementById('onboardingForm');

      console.log('Onboarding globals', {
        API_BASE_URL: window.API_BASE_URL,
        authManager: window.authManager,
        utils: window.utils
      });

      // Verify required globals
      if (!window.API_BASE_URL || !window.authManager || !window.utils) {
        console.error('Missing required globals', {
          API_BASE_URL: window.API_BASE_URL,
          authManager: window.authManager,
          utils: window.utils
        });
        return;
      }

      utils.showLoading();
      const configUrl = `${API_BASE_URL}/onboarding/config`;

      try {
        console.log('Fetching onboarding config:', configUrl);
        const response = await fetch(configUrl, {
          headers: {
            'Content-Type': 'application/json',
            ...authManager.getAuthHeaders()
          }
        });
        console.log('Config response status:', response.status);
        const data = await response.json();
        console.log('Config response data:', data);

        if (!data.success || !Array.isArray(data.questions)) {
          throw new Error('Configuration onboarding invalide');
        }

        data.questions.forEach(q => {
          const field = document.createElement('div');
          field.className = 'question-field';
          const label = document.createElement('label');
          label.textContent = q.label || q.question || q.id;
          label.setAttribute('for', `q_${q.id}`);
          field.appendChild(label);

          let input;
          switch (q.type) {
            case 'select':
              input = document.createElement('select');
              if (Array.isArray(q.options)) {
                q.options.forEach(opt => {
                  const option = document.createElement('option');
                  if (typeof opt === 'object') {
                    option.value = opt.value ?? opt.id ?? '';
                    option.textContent = opt.label ?? opt.value ?? opt.id ?? '';
                  } else {
                    option.value = opt;
                    option.textContent = opt;
                  }
                  input.appendChild(option);
                });
              }
              break;
            case 'textarea':
              input = document.createElement('textarea');
              break;
            default:
              input = document.createElement('input');
              input.type = q.type || 'text';
          }
          input.id = `q_${q.id}`;
          input.name = q.id;
          field.appendChild(input);

          form.appendChild(field);
        });

        const submit = document.createElement('button');
        submit.type = 'submit';
        submit.id = 'submitBtn';
        submit.className = 'submit-btn';
        submit.textContent = 'Envoyer';
        form.appendChild(submit);

        form.style.display = 'block';
      } catch (err) {
        console.error('Erreur chargement configuration onboarding', err);
        utils.handleAuthError('Erreur chargement questions');
      } finally {
        utils.hideLoading();
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        utils.showLoading(['submitBtn']);
        const formData = new FormData(form);
        const answers = Object.fromEntries(formData.entries());

        const submitUrl = `${API_BASE_URL}/onboarding/complete`;
        try {
          console.log('Submitting onboarding answers to:', submitUrl);
          const resp = await fetch(submitUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              ...authManager.getAuthHeaders()
            },
            body: JSON.stringify({ answers })
          });
          console.log('Submit response status:', resp.status);
          const result = await resp.json();
          console.log('Submit response data:', result);

          if (result.success) {
            if (window.onboardingManager) {
              await window.onboardingManager.checkOnboardingStatus(true);
            }
            window.location.href = '/app/';
          } else {
            utils.handleAuthError(result.error || 'Erreur lors de l\'envoi');
          }
        } catch (err) {
          console.error('Erreur envoi onboarding', err);
          utils.handleAuthError('Erreur envoi r√©ponses');
        } finally {
          utils.hideLoading(['submitBtn']);
        }
      });
    });
  </script>
</body>
</html>
